<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Infrared B&W Scanner, PNG + Record</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #000;
    overflow: hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: rgba(255,255,255,0.9);
  }
  canvas { width: 100vw; height: 100vh; display: block; }
  video { display: none; }

  #ui {
    position: fixed;
    top: 12px;
    left: 12px;
    right: 12px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    pointer-events: none;
  }
  .panel {
    pointer-events: auto;
    background: rgba(0,0,0,0.62);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 10px 12px;
    display: inline-flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .panel label {
    font-size: 12px;
    display: inline-flex;
    gap: 8px;
    align-items: center;
    white-space: nowrap;
    opacity: 0.95;
  }
  .panel input[type="range"] { width: 170px; }
  button {
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.20);
    color: rgba(255,255,255,0.92);
    padding: 8px 10px;
    border-radius: 10px;
    cursor: pointer;
  }
  button:hover { background: rgba(255,255,255,0.14); }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  #hint{
    position: fixed;
    bottom: 12px;
    left: 12px;
    right: 12px;
    font-size: 12px;
    opacity: 0.72;
    background: rgba(0,0,0,0.40);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 10px 12px;
    line-height: 1.35;
    pointer-events: none;
  }
</style>
</head>
<body>

<canvas id="c"></canvas>
<video id="v" autoplay playsinline muted></video>

<div id="ui">
  <div class="panel">
    <button id="startBtn">Start camera</button>
    <button id="clearBtn">Clear canvas</button>
    <button id="pngBtn">Save PNG</button>
  </div>

  <div class="panel">
    <button id="recBtn" disabled>Start recording</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div class="panel">
    <label>Scan speed
      <input id="scanSpeed" type="range" min="0.05" max="4" value="0.30" step="0.05">
    </label>
    <label>Decay
      <input id="decay" type="range" min="0" max="25" value="3">
    </label>
    <label>Mark density
      <input id="density" type="range" min="10" max="900" value="160">
    </label>
    <label>Sampling
      <input id="sampleRes" type="range" min="160" max="520" value="320" step="10">
    </label>
  </div>
</div>

<div id="hint">
  Monochrome “white hot” faux infrared, horizontal scanline accumulation with slow decay.
  Recording captures the canvas output (WebM). Use https or http://localhost for camera access.
</div>

<script>
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false });
  const video = document.getElementById('v');

  const startBtn = document.getElementById('startBtn');
  const clearBtn = document.getElementById('clearBtn');
  const pngBtn = document.getElementById('pngBtn');

  const recBtn = document.getElementById('recBtn');
  const stopBtn = document.getElementById('stopBtn');

  const scanSpeedEl = document.getElementById('scanSpeed');
  const decayEl = document.getElementById('decay');
  const densityEl = document.getElementById('density');
  const sampleResEl = document.getElementById('sampleRes');

  let w = 0, h = 0, dpr = 1;

  function fillBase() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, w, h);
  }

  function resize() {
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    w = Math.floor(window.innerWidth * dpr);
    h = Math.floor(window.innerHeight * dpr);
    canvas.width = w;
    canvas.height = h;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    fillBase();
  }
  window.addEventListener('resize', resize);
  resize();

  // Offscreen sampling buffer
  const sampleCanvas = document.createElement('canvas');
  const sctx = sampleCanvas.getContext('2d', { willReadFrequently: true });

  function ensureSampleCanvas() {
    const target = Number(sampleResEl.value);
    const vw = video.videoWidth || 1280;
    const vh = video.videoHeight || 720;
    const aspect = vw / vh;

    sampleCanvas.width = Math.max(80, Math.floor(target * aspect));
    sampleCanvas.height = Math.max(60, Math.floor(target));
  }

  // Scanner state
  let scanY = 0;

  function luminance(r, g, b) {
    return (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
  }

  // Recording
  let recorder = null;
  let recordedChunks = [];
  let recording = false;
  let streamForRecording = null;

  function pickMimeType() {
    const options = [
      'video/webm;codecs=vp9',
      'video/webm;codecs=vp8',
      'video/webm'
    ];
    for (const t of options) {
      if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
    }
    return '';
  }

  function startRecording() {
    if (recording) return;

    const fps = 30;
    streamForRecording = canvas.captureStream(fps);

    const mimeType = pickMimeType();
    try {
      recorder = new MediaRecorder(streamForRecording, mimeType ? { mimeType } : undefined);
    } catch (e) {
      alert('Recording is not supported in this browser.');
      return;
    }

    recordedChunks = [];
    recorder.ondataavailable = (ev) => {
      if (ev.data && ev.data.size > 0) recordedChunks.push(ev.data);
    };
    recorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: recorder.mimeType || 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `infrared_scanner_${Date.now()}.webm`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    };

    recorder.start();
    recording = true;

    recBtn.disabled = true;
    stopBtn.disabled = false;
    recBtn.textContent = 'Recording…';
  }

  function stopRecording() {
    if (!recording) return;
    recording = false;

    stopBtn.disabled = true;
    recBtn.disabled = false;
    recBtn.textContent = 'Start recording';

    try { recorder.stop(); } catch {}
    if (streamForRecording) {
      streamForRecording.getTracks().forEach(t => t.stop());
      streamForRecording = null;
    }
  }

  recBtn.addEventListener('click', startRecording);
  stopBtn.addEventListener('click', stopRecording);

  async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    video.srcObject = stream;
    await video.play();
    ensureSampleCanvas();

    startBtn.textContent = 'Camera running';
    startBtn.disabled = true;

    recBtn.disabled = false;
    stopBtn.disabled = true;

    scanY = 0;
    requestAnimationFrame(loop);
  }

  startBtn.addEventListener('click', async () => {
    try { await startCamera(); }
    catch (e) {
      console.error(e);
      alert('Camera access failed. Try https or http://localhost and allow permissions.');
    }
  });

  clearBtn.addEventListener('click', () => fillBase());

  pngBtn.addEventListener('click', () => {
    const a = document.createElement('a');
    a.download = `infrared_scanner_${Date.now()}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  sampleResEl.addEventListener('change', () => {
    if (video.readyState >= 2) ensureSampleCanvas();
  });

  function loop() {
    // Slow decay
    const decay = Number(decayEl.value);
    if (decay > 0) {
      ctx.fillStyle = `rgba(0,0,0,${decay / 1200})`;
      ctx.fillRect(0, 0, w, h);
    }

    // Sample current camera frame
    sctx.drawImage(video, 0, 0, sampleCanvas.width, sampleCanvas.height);
    const img = sctx.getImageData(0, 0, sampleCanvas.width, sampleCanvas.height);
    const data = img.data;

    // Advance scan row, serpentine movement for consistency
    const scanSpeed = Number(scanSpeedEl.value);
    scanY = (scanY + scanSpeed) % sampleCanvas.height;

    const yInt = Math.floor(scanY);
    const forward = (yInt % 2) === 0;

    const marks = Number(densityEl.value);

    const sx = w / sampleCanvas.width;
    const sy = h / sampleCanvas.height;

    // Draw marks only from this scan band (consistent scanner)
    for (let i = 0; i < marks; i++) {
      const t = Math.random();
      let px = Math.floor(t * sampleCanvas.width);
      if (!forward) px = (sampleCanvas.width - 1) - px;

      const py = yInt; // strict scanline
      const idx = (py * sampleCanvas.width + px) * 4;

      const l = luminance(data[idx], data[idx + 1], data[idx + 2]);
      const br = (l * 255) | 0;

      ctx.strokeStyle = `rgb(${br},${br},${br})`;
      ctx.lineWidth = 0.35 + 2.1 * l;

      const x = px * sx;
      const y = py * sy;

      // Small horizontal stroke
      ctx.beginPath();
      ctx.moveTo(x - 4 * sx, y);
      ctx.lineTo(x + 4 * sx, y);
      ctx.stroke();
    }

    requestAnimationFrame(loop);
  }
</script>
</body>
</html>
